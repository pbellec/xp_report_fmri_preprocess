<!DOCTYPE html>
<html>

<head>
  <title>Report on fMRI motion levels</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <link rel="stylesheet" type="text/css" href="motion.css" /> <!--Custom style sheet for motion report-->
  <link rel="stylesheet" type="text/css" href="assets/bootstrap/bootstrap.min.css" /> <!--from keen.io-->
  <link rel="stylesheet" type="text/css" href="assets/keen/keen-dashboards.css" />    <!--from keen.io-->
  <link href="assets/select2/select2.min.css" rel="stylesheet" /> <!--from select 2-->
  <link href="assets/c3js/c3.min.css" rel="stylesheet" type="text/css"> <!--from c3.js-->
</head>
<body class="application">

  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://niak.simexp-lab.org/pipe_preprocessing.html">fMRI preprocessing pipeline</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-left">
          <li><a href="index.html">Summary</a></li>
          <li><a href="registration.html">Registration</a></li>
          <li><a href="motion.html">Motion</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container-fluid">
           
<!-- FD plots -->
      <div class="col-sm-3">
        <div class="chart-wrapper">
          <div class="chart-title">
            Frame displacement
          </div>
          <div class="chart-stage">
            <div id="chartFd"></div>
          </div>
          <div class="chart-notes">
            Click to select a time point. Mouse scroll to zoom.
          </div>
        </div>
      </div>

<!-- Motion visualizer in native space -->
      <div class="col-sm-9">
        <div class="chart-wrapper">
          <div class="chart-title">
            fMRI time frames in native space
          </div>
          <div class="chart-stage" id="motionNative">
            <img class="sliderNext" src="assets/jsImageSlider/navbuttons2.gif" >
            <img class="sliderPrev" src="assets/jsImageSlider/navbuttons2.gif" >
            <canvas id="sliderNative"> 
            <img id="spriteNative" class="hidden" src="motion/motion_subject1_native.png">
          </div>
          <div class="chart-notes">
            Click the left/right arrows to go forward/backward in time.
          </div>
        </div>
      </div>
<!-- end of two -->
      
<!-- Translation plots -->
    <div class="row">
      <div class="col-sm-3">
        <div class="chart-wrapper">
          <div class="chart-title">
            Translation parameters
          </div>
          <div class="chart-stage">
            <div id="chartTsl"></div>
          </div>
          <div class="chart-notes">
            Click to select a time point. Mouse scroll to zoom.
          </div>
        </div>
      </div>

<!-- Motion visualizer in native space -->
      <div class="col-sm-9">
        <div class="chart-wrapper">
          <div class="chart-title">
            fMRI time frames in stereotaxic space
          </div>
          <div class="chart-stage" id="motionNative">
            <img class="sliderNext" src="assets/jsImageSlider/navbuttons2.gif" >
            <img class="sliderPrev" src="assets/jsImageSlider/navbuttons2.gif" >
            <canvas id="sliderStereo"> 
            <img id="spriteStereo" class="hidden" src="motion/motion_subject1_stereo.png">
          </div>
          <div class="chart-notes">
            Click the left/right arrows to go forward/backward in time.
          </div>
        </div>
      </div>
      
<!-- end of two -->
 
<!-- Rotation plots -->      
      <div class="col-sm-3">
        <div class="chart-wrapper">
          <div class="chart-title">
            Rotation parameters
          </div>
          <div class="chart-stage">
            <div id="chartRot" style="width:100%"></div>
          </div>
          <div class="chart-notes">
            Click to select a time point. Mouse scroll to zoom.
          </div>
        </div>
      </div>
      
<!-- Registration with the session/run of reference -->      
      <div class="col-sm-9">
        <div class="chart-wrapper">
          <div class="chart-title">
            Run vs Reference volume (session1_run1)
          </div>
          <div class="chart-stage">
            <div id="divRegistration" class="register">
            <img id="registration" src="motion/ref_volume.jpg" style="display:block; margin-left:auto; margin-right:auto">
            </div>
          </div>
          <div class="chart-notes">
            Hover the mouse over to switch between images. 
          </div>
        </div>
      </div>
<!-- end of two -->
    </div>



    <hr>

    <p class="small text-muted">Built with &#9829; by <a href="http://niak.simexp-lab.org">NIAK</a> using dashboards from <a href="https://keen.io">Keen IO</a></p>

  </div>

  <!--Dependencies-->
  <script src="assets/d3js/d3.min.js" charset="utf-8"></script>
  <script src="assets/c3js/c3.min.js"></script></head>
  <script type="text/javascript" src="assets/jquery/jquery.min.js"></script>       <!--from keen.io-->
  <script type="text/javascript" src="assets/bootstrap/bootstrap.min.js"></script> <!--from keen.io-->
  <script type="text/javascript" src="assets/keen/keen.min.js"></script>           <!--from keen.io-->
  <script src="assets/select2/select2.min.js"></script> <!--from select 2-->
  
  <script> 
  var numFrame = 0;
  var percVisu = 0.7;
  var spacerNative = new Image();
  spacerNative.src = "motion/spacer.png";
  var spacerStereo = new Image();
  spacerStereo.src = "motion/spacer_stereo.png";
  var percVisuStr = 100*percVisu;
  percVisuStr = percVisuStr.toString()+"%";
  $( window ).load(function() {
    selectTime(numFrame);
    $("#registration").width(percVisuStr);
    figRegistration = $("#divRegistration");
    figRegistration.css("backgroundImage","url('motion/median_volume.jpg')");
    figRegistration.css("backgroundSize",percVisuStr);
    figRegistration.css("backgroundPosition","center");
    figRegistration.css("backgroundRepeat","no-repeat");
  });
  window.addEventListener("resize", function() {selectTime(numFrame);}); 
    
  var tsl = {
  columns: [
    ['motion_tx',0.020 ,0.075 ,0.045 ,0.087 ,0.052 ,0.023 ,0.011 ,0.024 ,-0.009 ,-0.049 ,-0.058 ,0.020 ,-0.017 ,0.007 ,-0.012 ,-0.028 ,-0.023 ,-0.040 ,-0.028 ,0.001 ,-0.008 ,0.001 ,0.034 ,0.027 ,0.025 ,0.014 ,0.018 ,0.020 ,0.031 ,0.012 ],
['motion_ty',-0.012 ,-0.012 ,0.017 ,-0.003 ,-0.006 ,-0.028 ,-0.001 ,-0.016 ,0.003 ,0.001 ,0.022 ,-0.007 ,0.045 ,-0.008 ,-0.073 ,-0.037 ,-0.020 ,0.022 ,0.014 ,-0.012 ,-0.021 ,-0.047 ,-0.003 ,-0.039 ,-0.049 ,0.004 ,-0.017 ,0.017 ,-0.011 ,0.000 ],
['motion_tz',-0.266 ,-0.126 ,-0.106 ,-0.093 ,0.009 ,-0.038 ,-0.002 ,-0.006 ,0.005 ,0.061 ,0.007 ,-0.184 ,-0.001 ,0.028 ,0.091 ,0.109 ,0.122 ,0.108 ,0.095 ,0.063 ,0.054 ,0.005 ,-0.136 ,0.011 ,0.006 ,-0.015 ,-0.008 ,0.064 ,0.075 ,0.066 ]
    ],
  selection: {
    enabled: true
    },
  onclick: function (d) { selectTime(d.index);}
  };
  
  var rot = {
  columns: [
    ['motion_rx',-0.340 ,-0.114 ,-0.091 ,-0.132 ,-0.137 ,-0.127 ,-0.069 ,-0.034 ,-0.043 ,-0.013 ,-0.060 ,-0.174 ,0.003 ,-0.009 ,0.044 ,0.083 ,0.090 ,0.108 ,0.098 ,0.070 ,0.082 ,0.011 ,-0.131 ,0.049 ,0.020 ,0.050 ,0.038 ,0.107 ,0.093 ,0.084 ],
['motion_ry',0.070 ,0.001 ,0.048 ,0.034 ,0.036 ,0.035 ,0.016 ,-0.029 ,-0.012 ,-0.037 ,-0.020 ,0.027 ,0.033 ,-0.095 ,-0.137 ,-0.036 ,0.030 ,-0.003 ,-0.010 ,0.012 ,-0.027 ,-0.018 ,0.018 ,-0.038 ,-0.040 ,-0.019 ,-0.041 ,-0.036 ,-0.015 ,-0.007 ],
['motion_rz',-0.034 ,-0.044 ,-0.004 ,-0.053 ,-0.037 ,-0.011 ,0.001 ,-0.017 ,0.027 ,0.026 ,0.055 ,-0.016 ,0.032 ,-0.019 ,-0.046 ,0.029 ,0.017 ,0.024 ,0.024 ,-0.012 ,-0.010 ,-0.011 ,-0.045 ,-0.019 ,-0.047 ,-0.056 ,-0.059 ,-0.037 ,-0.011 ,-0.053 ]
    ],
  selection: {
    enabled: true
    },
  onclick: function (d) { selectTime(d.index);}
  };

  var fd = {
  columns: [
    ['FD',0.462 ,0.176 ,0.166 ,0.159 ,0.131 ,0.152 ,0.119 ,0.127 ,0.146 ,0.166 ,0.504 ,0.477 ,0.277 ,0.255 ,0.258 ,0.110 ,0.124 ,0.048 ,0.166 ,0.074 ,0.153 ,0.405 ,0.420 ,0.068 ,0.139 ,0.065 ,0.192 ,0.105 ,0.092 ,0 ],
['scrub',0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,1 ,1 ,1 ,1 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ]
    ],
  selection: {
    enabled: true
    },
  onclick: function (d) { selectTime(d.index);}
  };
    
  var chartTsl = c3.generate({
    bindto: '#chartTsl',
    data: tsl,
    axis: {
        x: {
            label: 'Time (TRs)'
        },
        y: {
            label: 'Translation (mm)',
            tick: {
                format: d3.format('0.2f'),
            }
        }
    },
    zoom: {
      enabled: true
    },
  });
  
  var chartRot = c3.generate({
    bindto: '#chartRot',
    data: rot,
    axis: {
        x: {
            label: 'Time (TRs)'
        },
        y: {
            label: 'Rotation (degrees))',
            tick: {
                format: d3.format('0.2f')
            }
        }
    },
    zoom: {
      enabled: true
    }
  });
  
  var chartFd = c3.generate({
    bindto: '#chartFd',
    data: fd,
    axis: {
        x: {
            label: 'Time (TRs)'
        },
        y: {
            label: 'Frame displacement (pseudo mm))',
            tick: {
                format: d3.format('0.2f')
            }
        },
        y2: {
            show: true,
            label: 'Scrubbing (0: no / 1: yes))',
            tick: {
                format: d3.format('b')
            }
        }
    },
    zoom: {
      enabled: true
    }
  });
  
  function drawMotion(frame,type) {
    var canvas = document.getElementById("slider" + type);
    var wImg = $("#slider"+type).parent().width();    
    if (type==="Native") {
      var wSpacer = spacerNative.width;
      var hSpacer = spacerNative.height; }
    else {
      var wSpacer = spacerStereo.width;
      var hSpacer = spacerStereo.height; 
    };
    var rSpacer = hSpacer / wSpacer ;
    var hImg = Math.round(wImg * percVisu * rSpacer);
    if (canvas.width!=wImg) {   
      canvas.width = wImg;
      canvas.height = hImg;
    };    
    var ctx = canvas.getContext('2d');
    ctx.drawImage(document.getElementById("sprite"+type),
                frame*wSpacer, 0, wSpacer, hSpacer, wImg*(1-percVisu)/2, 0, wImg*percVisu, hImg );
    ctx.fillStyle = "#ffffff";
    ctx.fillText("Frame number "+frame+"/49",wImg*1.2*(1-percVisu)/2,0.05*hImg);
    numFrame = frame;
    return hImg
    };
    
  function selectTime(frame) {
    hImgNative = drawMotion(frame,"Native");
    if ($("#chartFd").height()!=hImgNative) {
      chartFd.resize({height:hImgNative});
    };
    hImgStereo = drawMotion(frame,"Stereo");
    if ($("#chartTsl").height()!=hImgStereo) {
      chartTsl.resize({height:hImgStereo});
    };
    chartTsl.select(['motion_tx' , 'motion_ty' , 'motion_tz'], [frame], true);
    chartRot.select(['motion_rx' , 'motion_ry' , 'motion_rz'], [frame], true);
    chartFd.select(['FD' , 'scrub' ], [frame], true);
    };
    
  function nextTime() {
    nextFrame = numFrame+1;
    if (nextFrame>49){return} else {selectTime(nextFrame)};
    };

  function prevTime() {
    prevFrame = numFrame - 1;
    if (prevFrame<0){return} else {selectTime(prevFrame)};
    };

  function reactKey(key){
    if (key==39) {
      nextTime()
    } 
    else if (key==37) {
      prevTime() 
    };
  };
  
  window.onload = function() {
    
    document.getElementsByClassName("sliderNext")[0].onclick = function fun() {
      nextTime();
      }
    document.getElementsByClassName("sliderNext")[1].onclick = function fun() {
      nextTime();
      }
    document.getElementsByClassName("sliderPrev")[0].onclick = function fun() {
      prevTime();
      }
    document.getElementsByClassName("sliderPrev")[1].onclick = function fun() {
      prevTime();
      }
    };
    
  window.onkeydown = function(e) { reactKey(e.keyCode) 
      };


  </script>
 
</body>
</html>
